name: Release - CI + JMeter Load Test

on:
  push:
    branches:
      - release
  pull_request:
    branches:
      - main

env:
  JAVA_VERSION: '21'

jobs:
  build-and-test:
    name: Build and Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: temurin
          cache: maven
      - run: mvn clean install
      - uses: actions/upload-artifact@v4
        with:
          name: app-jar
          path: target/*.jar

  jmeter-load-test:
    name: JMeter Load Test
    needs: build-and-test
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: vanessa_mudanca_clientes
          POSTGRES_USER: user
          POSTGRES_PASSWORD: senha123
        options: --health-cmd pg_isready --health-interval 10s
        ports:
          - 5432:5432
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: temurin
      - uses: actions/download-artifact@v4
        with:
          name: app-jar
          path: target/
      - name: Start Application
        run: |
          java -jar target/*.jar --spring.profiles.active=dev &
          sleep 40
          curl --retry 15 --retry-delay 5 http://localhost:8081/api/clientes/actuator/health
        env:
          SPRING_DATASOURCE_URL: jdbc:postgresql://localhost:5432/vanessa_mudanca_clientes
          SPRING_DATASOURCE_USERNAME: user
          SPRING_DATASOURCE_PASSWORD: senha123
      - uses: rbhadti94/apache-jmeter-action@v0.7.0
        with:
          testFilePath: .jmeter/tests/load-test.jmx
          outputReportsFolder: jmeter-reports/
          args: -Jthreads=100 -Jrampup=30 -Jduration=120
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: jmeter-load-results
          path: jmeter-reports/
      - name: Performance Gate
        run: |
          echo "Validating performance thresholds"
          if [ -f jmeter-reports/statistics.json ]; then
            cat jmeter-reports/statistics.json
            echo "Load test completed successfully"
          fi
