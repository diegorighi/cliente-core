name: Developer - CI + JMeter Smoke Test

on:
  push:
    branches:
      - developer
  pull_request:
    branches:
      - release

env:
  JAVA_VERSION: '21'

jobs:
  build-and-test:
    name: Build and Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: temurin
          cache: maven
      - run: mvn clean install
      - uses: actions/upload-artifact@v4
        with:
          name: app-jar
          path: target/*.jar

  jmeter-smoke-test:
    name: JMeter Smoke Test
    needs: build-and-test
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: vanessa_mudanca_clientes
          POSTGRES_USER: user
          POSTGRES_PASSWORD: senha123
        options: --health-cmd pg_isready --health-interval 10s
        ports:
          - 5432:5432
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: temurin
      - uses: actions/download-artifact@v4
        with:
          name: app-jar
          path: target/
      - name: Start Application
        run: |
          java -jar target/*.jar --spring.profiles.active=dev &
          sleep 30
          curl --retry 10 --retry-delay 5 http://localhost:8081/api/clientes/actuator/health
        env:
          SPRING_DATASOURCE_URL: jdbc:postgresql://localhost:5432/vanessa_mudanca_clientes
          SPRING_DATASOURCE_USERNAME: user
          SPRING_DATASOURCE_PASSWORD: senha123
      - uses: rbhadti94/apache-jmeter-action@v0.7.0
        with:
          testFilePath: .jmeter/tests/smoke-test.jmx
          outputReportsFolder: jmeter-reports/
          args: -Jthreads=10 -Jrampup=5 -Jduration=30
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: jmeter-smoke-results
          path: jmeter-reports/
