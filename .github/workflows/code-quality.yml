name: Code Quality and Security
on:
  push:
    branches: [developer, release, main]
  pull_request:
    branches: [developer, release, main]
env:
  JAVA_VERSION: 21
  # SonarCloud configuration
  # GitHub repo: diegorighi/cliente-core (will be transferred to va-nessa-mudanca)
  # SonarCloud org: va-nessa-mudanca (already created)
  #
  # IMPORTANT: Even though GitHub repo is still diegorighi/cliente-core,
  # we're using va-nessa-mudanca organization in SonarCloud (preparing for migration)
  SONAR_ORGANIZATION: va-nessa-mudanca
  SONAR_PROJECT_KEY: va-nessa-mudanca_cliente-core
jobs:
  sonarcloud:
    name: SonarCloud Analysis
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Shallow clones should be disabled for better analysis
      - uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: temurin
          cache: maven
      - uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar
      - name: Build and analyze with SonarCloud
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_ORG: ${{ env.SONAR_ORGANIZATION }}
          SONAR_KEY: ${{ env.SONAR_PROJECT_KEY }}
        run: |
          mvn clean verify sonar:sonar \
            -Dsonar.projectKey=${SONAR_KEY} \
            -Dsonar.organization=${SONAR_ORG} \
            -Dsonar.host.url=https://sonarcloud.io
      - uses: sonarsource/sonarcloud-github-action@master
        continue-on-error: true
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
  dependency-check:
    name: OWASP Dependency Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: temurin
          cache: maven
      - name: Run OWASP Dependency Check
        env:
          NVD_API_KEY: ${{ secrets.NVD_API_KEY }}
        run: mvn verify -Dowasp.skip=false
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dependency-check-report
          path: target/dependency-check-report.html
  codeql:
    name: CodeQL Security
    runs-on: ubuntu-latest
    permissions:
      security-events: write
    steps:
      - uses: actions/checkout@v4
      - uses: github/codeql-action/init@v3
        with:
          languages: java
      - uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: temurin
          cache: maven
      - name: Build with retry (handle Maven Central intermittent failures)
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 10
          max_attempts: 3
          retry_wait_seconds: 30
          command: mvn clean package -DskipTests
      - uses: github/codeql-action/analyze@v3
